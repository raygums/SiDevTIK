name: Sync to Bitbucket

on:
  push:
    branches:
      - '*'
    tags:
      - '*'
  delete: 
  workflow_dispatch:
  
jobs:
  sync-to-bitbucket:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          
      - name: Setup SSH for Bitbucket
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.BITBUCKET_SSH_KEY }}

      - name: Sync to Bitbucket
        env:
          TARGET_REPO: git@bitbucket.org:mahendraunila/si-project-tik.git
        run: |
          # 1. Konfigurasi Git User
          git config --global user.email "bot@github.com"
          git config --global user.name "GitHub Sync Bot"
          
          # 2. Tambahkan Remote Bitbucket
          git remote add bitbucket $TARGET_REPO
          
          # 3. Setup Keamanan Host Key 
          mkdir -p ~/.ssh
          ssh-keyscan bitbucket.org >> ~/.ssh/known_hosts
          
          # 4. Sinkronisasi Penuh (All, Tags, & Prune)
          # --all   : Push semua branch yang ada
          # --tags  : Push semua tag
          # --force : Timpa history di Bitbucket jika ada force push di GitHub (rebase/amend)
          # --prune : HAPUS branch di Bitbucket yang sudah tidak ada di GitHub (Menangani Delete & Rename)
          
          echo "Starting synchronization..."
          git push bitbucket --all --force
          git push bitbucket --tags --force
          git push bitbucket --prune
          
          echo "Synchronization complete."
