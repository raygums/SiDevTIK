name: Sync to Bitbucket (One-Way)

on:
  push:
    branches:
      - '*' # Sinkronisasi semua branch
    tags:
      - '*' # Sinkronisasi semua tag
  delete: # Trigger saat branch dihapus di GitHub
  workflow_dispatch: # Tombol manual untuk memaksa sync

jobs:
  sync-to-bitbucket:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Mengambil history lengkap agar push valid

      - name: Setup SSH for Bitbucket
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.BITBUCKET_SSH_KEY }}

      - name: Sync to Bitbucket
        env:
          TARGET_REPO: git@bitbucket.org:mahendraunila/si-project-tik.git
        run: |
          # 1. Konfigurasi Git User
          git config --global user.email "bot@github.com"
          git config --global user.name "GitHub Sync Bot"
          
          # 2. Setup Remote
          git remote add bitbucket $TARGET_REPO
          
          # 3. Setup Keamanan Host Key
          mkdir -p ~/.ssh
          ssh-keyscan bitbucket.org >> ~/.ssh/known_hosts
          
          # 4. Eksekusi Sinkronisasi
          if [ "${{ github.event_name }}" == "delete" ]; then
            # Hapus branch di Bitbucket jika dihapus di GitHub
            echo "ğŸ—‘ï¸ Deleting ref on Bitbucket..."
            git push bitbucket --delete "${{ github.event.ref }}"
          else
            # Push perubahan ke Bitbucket
            echo "â¡ï¸ Pushing to Bitbucket..."
            # Tanpa --force: Aman. Jika ada konflik, pipeline gagal (Anda harus manual fix).
            git push bitbucket "${{ github.ref }}"
          fi