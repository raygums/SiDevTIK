name: Sync to Bitbucket

on:
  push:
    branches:
      - '*'
    tags:
      - '*'
  delete:
  workflow_dispatch:

jobs:
  sync-to-bitbucket:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Mengambil seluruh history agar tidak error saat push

      - name: Setup SSH for Bitbucket
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.BITBUCKET_SSH_KEY }}

      - name: Sync to Bitbucket
        env:
          TARGET_REPO: git@bitbucket.org:mahendraunila/si-project-tik.git
        run: |
          # 1. Konfigurasi Git User (Formalitas untuk git)
          git config --global user.email "bot@github.com"
          git config --global user.name "GitHub Sync Bot"
          
          # 2. Tambahkan Remote Bitbucket
          git remote add bitbucket $TARGET_REPO
          
          # 3. Setup Keamanan Host Key
          mkdir -p ~/.ssh
          ssh-keyscan bitbucket.org >> ~/.ssh/known_hosts
          
          # ========================================================
          # 4. SINKRONISASI TOTAL (MIRRORING)
          # ========================================================
          
          # Langkah A: Pastikan Runner memiliki SEMUA branch dari GitHub (Origin)
          echo "Mengambil update terbaru dari GitHub..."
          git fetch origin "+refs/heads/*:refs/heads/*" --update-head-ok
          
          # Langkah B: Push ke Bitbucket dengan opsi --prune
          # --all   : Push semua branch yang ada di lokal (hasil fetch tadi).
          # --force : Paksa update jika history berbeda (penting untuk rebase/amend).
          # --prune : HAPUS branch di Bitbucket yang TIDAK ADA di GitHub.
          
          echo "Sinkronisasi ke Bitbucket (Push, Delete, Rename)..."
          git push bitbucket --all --force --prune
          
          # Langkah C: Push Tags
          echo "Sinkronisasi Tags..."
          git push bitbucket --tags --force
